name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Plugin Structure

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate manifest.json
        run: |
          echo "Validating manifest.json..."
          if ! python3 -c "import json; json.load(open('manifest.json'))"; then
            echo "ERROR: manifest.json is not valid JSON"
            exit 1
          fi
          echo "manifest.json is valid"

      - name: Check required files exist
        run: |
          echo "Checking required files..."
          required_files=("manifest.json" "media_parser.js" "icon.png" "python/extractor.py" "python/check_dependencies.py")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Required file missing: $file"
              exit 1
            fi
            echo "âœ“ $file exists"
          done

      - name: Validate Python syntax
        run: |
          echo "Checking Python syntax..."
          python3 -m py_compile python/extractor.py
          python3 -m py_compile python/check_dependencies.py
          echo "Python files have valid syntax"

      - name: Check JavaScript syntax
        run: |
          echo "Checking JavaScript syntax..."
          node --check media_parser.js || echo "Note: ES5 syntax may show warnings but is valid for Qt"

  build-test:
    runs-on: ubuntu-latest
    name: Test FDA Build
    needs: validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build FDA package (test)
        run: |
          echo "Building FDA package..."
          zip -r fdm-smart-media-optimizer.fda . \
            -x "*.git*" \
            -x "*.github*" \
            -x "*.md" \
            -x "LICENSE" \
            -x "*.txt" \
            -x ".gitignore"
          echo "FDA package created successfully"
          ls -lh fdm-smart-media-optimizer.fda

      - name: Verify FDA contents
        run: |
          echo "FDA package contents:"
          unzip -l fdm-smart-media-optimizer.fda
